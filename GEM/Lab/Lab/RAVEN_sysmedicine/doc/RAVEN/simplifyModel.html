<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of simplifyModel</title>
  <meta name="keywords" content="simplifyModel">
  <meta name="description" content="simplifyModel">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html v1.5 &copy; 2003-2005 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../m2html.css">
</head>
<body>
<a name="_top"></a>
<div><a href="../index.html">Home</a> &gt;  <a href="index.html">RAVEN</a> &gt; simplifyModel.m</div>

<!--<table width="100%"><tr><td align="left"><a href="../index.html"><img alt="<" border="0" src="../left.png">&nbsp;Master index</a></td>
<td align="right"><a href="index.html">Index for RAVEN&nbsp;<img alt=">" border="0" src="../right.png"></a></td></tr></table>-->

<h1>simplifyModel
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="box"><strong>simplifyModel</strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="box"><strong>function [reducedModel, deletedReactions, deletedMetabolites]=simplifyModel(model,deleteUnconstrained, deleteDuplicates, deleteZeroInterval, deleteInaccessible, deleteMinMax, groupLinear, reservedRxns, suppressWarnings) </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="fragment"><pre class="comment"> simplifyModel
   Simplifies a model by deleting reactions/metabolites

   model                 a model structure
   deleteUnconstrained   delete metabolites marked as unconstrained (opt, default true)
   deleteDuplicates      delete all but one of duplicate reactions (opt, default false)
   deleteZeroInterval    delete reactions that are constrained to zero flux (opt, default false)
   deleteInaccessible    delete dead end reactions (opt, default false)
   deleteMinMax          delete reactions that cannot carry a flux by trying
                         to minimize/maximize the flux through that
                         reaction. May be time consuming (opt, default false)
   groupLinear           group linear pathways (opt, default false)
   reservedRxns          cell array with reaction IDs that are not allowed to be
                         removed (opt)
   suppressWarnings      true if warnings should be suppressed (opt,
                         default false)

   reducedModel          an updated model structure
   deletedReactions      a cell array with the IDs of all deleted reactions
   deletedMetabolites    a cell array with the IDs of all deleted
                         metabolites

   This function is for reducing the model size by removing
   reactions and associated metabolites that cannot carry flux. It can also
   be used for identifying different types of gaps.

   Usage: [reducedModel, deletedReactions, deletedMetabolites]=simplifyModel(model,...
           deleteUnconstrained, deleteDuplicates, deleteZeroInterval,...
           deleteInaccessible, deleteMinMax, groupLinear, reservedRxns,...
           suppressWarnings)

   Rasmus Agren, 2013-08-01</pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../matlabicon.gif)">
<li><a href="contractModel.html" class="code" title="function [reducedModel removedRxns]=contractModel(model)">contractModel</a>	contractModel</li><li><a href="dispEM.html" class="code" title="function dispEM(string,throwErrors,toList,trimWarnings)">dispEM</a>	dispEM</li><li><a href="getIndexes.html" class="code" title="function indexes=getIndexes(model,objects, type, returnLogical)">getIndexes</a>	getIndexes</li><li><a href="haveFlux.html" class="code" title="function I=haveFlux(model,cutOff,rxns)">haveFlux</a>	haveFlux</li><li><a href="removeMets.html" class="code" title="function reducedModel=removeMets(model,metsToRemove,isNames,removeUnusedRxns,removeUnusedGenes,removeUnusedComps)">removeMets</a>	removeMets</li><li><a href="removeRxns.html" class="code" title="function reducedModel=removeRxns(model,rxnsToRemove,removeUnusedMets,removeUnusedGenes,removeUnusedComps)">removeRxns</a>	removeRxns</li></ul>
This function is called by:
<ul style="list-style-image:url(../matlabicon.gif)">
<li><a href="fillGaps.html" class="code" title="function [newConnected cannotConnect addedRxns newModel exitFlag]=fillGaps(model,models,allowNetProduction,useModelConstraints,supressWarnings,rxnScores,params)">fillGaps</a>	fillGaps</li><li><a href="findGeneDeletions.html" class="code" title="function [genes fluxes originalGenes details]=findGeneDeletions(model,testType,analysisType,refModel,oeFactor)">findGeneDeletions</a>	findGeneDeletions</li><li><a href="gapReport.html" class="code" title="function [noFluxRxns, noFluxRxnsRelaxed, subGraphs, notProducedMets, minToConnect,neededForProductionMat, canProduceWithoutInput, canConsumeWithoutOutput,connectedFromTemplates, addedFromTemplates]=gapReport(model, templateModels)">gapReport</a>	gapReport</li><li><a href="getINITModel.html" class="code" title="function [model metProduction essentialRxnsForTasks addedRxnsForTasks deletedDeadEndRxns deletedRxnsInINIT taskReport]=getINITModel(refModel, tissue, celltype, hpaData, arrayData, metabolomicsData, taskFile, useScoresForTasks, printReport, taskStructure, params, paramsFT)">getINITModel</a>	getINITModel</li><li><a href="haveFlux.html" class="code" title="function I=haveFlux(model,cutOff,rxns)">haveFlux</a>	haveFlux</li><li><a href="importExcelModel.html" class="code" title="function model=importExcelModel(fileName,removeExcMets,printWarnings,ignoreErrors)">importExcelModel</a>	importExcelModel</li><li><a href="importModel.html" class="code" title="function model=importModel(fileName,removeExcMets,isCOBRA,supressWarnings)">importModel</a>	importModel</li><li><a href="printModelStats.html" class="code" title="function printModelStats(model, printModelIssues, printDetails)">printModelStats</a>	printModelStats</li><li><a href="randomSampling.html" class="code" title="function solutions=randomSampling(model, nSamples, replaceBoundsWithInf,supressErrors)">randomSampling</a>	randomSampling</li></ul>
<!-- crossreference -->



<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="fragment"><pre>0001 <a name="_sub0" href="#_subfunctions" class="code">function [reducedModel, deletedReactions, deletedMetabolites]=simplifyModel(model,</a><span class="keyword">...</span>
0002     deleteUnconstrained, deleteDuplicates, deleteZeroInterval, deleteInaccessible, deleteMinMax, groupLinear, reservedRxns, suppressWarnings)
0003 <span class="comment">% simplifyModel</span>
0004 <span class="comment">%   Simplifies a model by deleting reactions/metabolites</span>
0005 <span class="comment">%</span>
0006 <span class="comment">%   model                 a model structure</span>
0007 <span class="comment">%   deleteUnconstrained   delete metabolites marked as unconstrained (opt, default true)</span>
0008 <span class="comment">%   deleteDuplicates      delete all but one of duplicate reactions (opt, default false)</span>
0009 <span class="comment">%   deleteZeroInterval    delete reactions that are constrained to zero flux (opt, default false)</span>
0010 <span class="comment">%   deleteInaccessible    delete dead end reactions (opt, default false)</span>
0011 <span class="comment">%   deleteMinMax          delete reactions that cannot carry a flux by trying</span>
0012 <span class="comment">%                         to minimize/maximize the flux through that</span>
0013 <span class="comment">%                         reaction. May be time consuming (opt, default false)</span>
0014 <span class="comment">%   groupLinear           group linear pathways (opt, default false)</span>
0015 <span class="comment">%   reservedRxns          cell array with reaction IDs that are not allowed to be</span>
0016 <span class="comment">%                         removed (opt)</span>
0017 <span class="comment">%   suppressWarnings      true if warnings should be suppressed (opt,</span>
0018 <span class="comment">%                         default false)</span>
0019 <span class="comment">%</span>
0020 <span class="comment">%   reducedModel          an updated model structure</span>
0021 <span class="comment">%   deletedReactions      a cell array with the IDs of all deleted reactions</span>
0022 <span class="comment">%   deletedMetabolites    a cell array with the IDs of all deleted</span>
0023 <span class="comment">%                         metabolites</span>
0024 <span class="comment">%</span>
0025 <span class="comment">%   This function is for reducing the model size by removing</span>
0026 <span class="comment">%   reactions and associated metabolites that cannot carry flux. It can also</span>
0027 <span class="comment">%   be used for identifying different types of gaps.</span>
0028 <span class="comment">%</span>
0029 <span class="comment">%   Usage: [reducedModel, deletedReactions, deletedMetabolites]=simplifyModel(model,...</span>
0030 <span class="comment">%           deleteUnconstrained, deleteDuplicates, deleteZeroInterval,...</span>
0031 <span class="comment">%           deleteInaccessible, deleteMinMax, groupLinear, reservedRxns,...</span>
0032 <span class="comment">%           suppressWarnings)</span>
0033 <span class="comment">%</span>
0034 <span class="comment">%   Rasmus Agren, 2013-08-01</span>
0035 <span class="comment">%</span>
0036 
0037 <span class="keyword">if</span> nargin&lt;2
0038     deleteUnconstrained=true;
0039 <span class="keyword">end</span>
0040 <span class="keyword">if</span> nargin&lt;3
0041     deleteDuplicates=false;
0042 <span class="keyword">end</span>
0043 <span class="keyword">if</span> nargin&lt;4
0044     deleteZeroInterval=false;
0045 <span class="keyword">end</span>
0046 <span class="keyword">if</span> nargin&lt;5
0047     deleteInaccessible=false;
0048 <span class="keyword">end</span>
0049 <span class="keyword">if</span> nargin&lt;6
0050     deleteMinMax=false;
0051 <span class="keyword">end</span>
0052 <span class="keyword">if</span> nargin&lt;7
0053     groupLinear=false;
0054 <span class="keyword">end</span>
0055 <span class="keyword">if</span> nargin&lt;8
0056     reservedRxns=[];
0057 <span class="keyword">end</span>
0058 <span class="keyword">if</span> nargin&lt;9
0059     suppressWarnings=false;
0060 <span class="keyword">end</span>
0061 
0062 reducedModel=model;
0063 deletedReactions={};
0064 deletedMetabolites={};
0065 
0066 <span class="keyword">if</span> deleteUnconstrained==true
0067     <span class="keyword">if</span> isfield(reducedModel,<span class="string">'unconstrained'</span>)
0068         <span class="comment">%Remove unbalanced metabolites</span>
0069         deletedMetabolites=reducedModel.mets(reducedModel.unconstrained~=0);
0070         reducedModel=<a href="removeMets.html" class="code" title="function reducedModel=removeMets(model,metsToRemove,isNames,removeUnusedRxns,removeUnusedGenes,removeUnusedComps)">removeMets</a>(reducedModel,reducedModel.unconstrained~=0);
0071         reducedModel=rmfield(reducedModel,<span class="string">'unconstrained'</span>);
0072     <span class="keyword">end</span>
0073 <span class="keyword">end</span>
0074 
0075 <span class="keyword">if</span> deleteDuplicates==true
0076     <span class="comment">%Delete all but the last occurrence of duplicate reactions. The</span>
0077     <span class="comment">%reactions must have the same bounds, reversibility, and objective</span>
0078     <span class="comment">%coefficient to be regarded as duplicate</span>
0079     [reducedModel rxnsToDelete]=<a href="contractModel.html" class="code" title="function [reducedModel removedRxns]=contractModel(model)">contractModel</a>(reducedModel);
0080     deletedReactions=[deletedReactions; rxnsToDelete];
0081 <span class="keyword">end</span>
0082 
0083 <span class="keyword">if</span> deleteZeroInterval==true
0084     <span class="comment">%Find all reactions where both LB and UB are 0</span>
0085     zeroIntervalReactions=and(reducedModel.lb==0,reducedModel.ub==0);
0086     
0087     rxnsToDelete=setdiff(reducedModel.rxns(zeroIntervalReactions),reservedRxns);
0088     deletedReactions=[deletedReactions; rxnsToDelete];   
0089     
0090     <span class="comment">%Remove reactions</span>
0091     reducedModel=<a href="removeRxns.html" class="code" title="function reducedModel=removeRxns(model,rxnsToRemove,removeUnusedMets,removeUnusedGenes,removeUnusedComps)">removeRxns</a>(reducedModel,rxnsToDelete);
0092     
0093     <span class="comment">%Find metabolites that no longer are used and delete them</span>
0094     notInUse=sum(reducedModel.S~=0,2)==0;
0095     deletedMetabolites=[deletedMetabolites;reducedModel.mets(notInUse)];
0096     
0097     <span class="comment">%Remove metabolites</span>
0098     reducedModel=<a href="removeMets.html" class="code" title="function reducedModel=removeMets(model,metsToRemove,isNames,removeUnusedRxns,removeUnusedGenes,removeUnusedComps)">removeMets</a>(reducedModel,notInUse);
0099 <span class="keyword">end</span>
0100 
0101 <span class="keyword">if</span> deleteInaccessible==true
0102     <span class="comment">%Print a warning if exchange metabolites haven't been deleted yet. This</span>
0103     <span class="comment">%often means that the only allowed products are the metabolites that</span>
0104     <span class="comment">%are taken up be the system</span>
0105     <span class="keyword">if</span> isfield(reducedModel,<span class="string">'unconstrained'</span>) &amp;&amp; suppressWarnings==false
0106        <a href="dispEM.html" class="code" title="function dispEM(string,throwErrors,toList,trimWarnings)">dispEM</a>(<span class="string">'Removing dead-end reactions before removing exchange metabolites'</span>,false); 
0107     <span class="keyword">end</span>
0108     
0109     <span class="keyword">while</span> true
0110         <span class="comment">%Find all metabolites that are only reactants or only products.</span>
0111         <span class="comment">%Delete those metabolites and reactions. This is done until no more</span>
0112         <span class="comment">%such reactions are found</span>
0113         
0114         <span class="comment">%Construct a stoichiometric matrix where all reactions are written</span>
0115         <span class="comment">%as reversible</span>
0116         
0117         <span class="comment">%Add fake exchange reactions if model.b~=0</span>
0118         in=any(reducedModel.b&lt;0,2);
0119         out=any(reducedModel.b&gt;0,2);
0120         I=speye(numel(reducedModel.mets));
0121         revS=[reducedModel.S,reducedModel.S(:,reducedModel.rev~=0)*-1 I(:,in) I(:,out)*-1];
0122         
0123         metUsage=sum(abs(revS')&gt;0);
0124         onlyProducts=sum(revS'&gt;0) == metUsage;
0125         onlyReactants=sum(revS'&lt;0) == metUsage;
0126         
0127         <span class="comment">%Also remove metabolites that only participate in one reversible reaction</span>
0128         <span class="comment">%Don't remove the ones in one reversible reaction if is also has a</span>
0129         <span class="comment">%non-zero coefficient in model.b</span>
0130         notInUse=onlyProducts | onlyReactants | (sum(abs(reducedModel.S')&gt;0)&lt;=1 &amp; (~in &amp; ~out)');
0131         deletedRxn=false;
0132         <span class="keyword">if</span> any(notInUse)        
0133             <span class="comment">%Find their corresponding reactions</span>
0134             rxnsNotInUse=sum(abs(reducedModel.S(notInUse,:))&gt;0,1)&gt;0;
0135             rxnsToDelete=setdiff(reducedModel.rxns(rxnsNotInUse),reservedRxns);
0136             deletedReactions=[deletedReactions; rxnsToDelete];
0137             
0138             <span class="comment">%Remove reactions</span>
0139             reducedModel=<a href="removeRxns.html" class="code" title="function reducedModel=removeRxns(model,rxnsToRemove,removeUnusedMets,removeUnusedGenes,removeUnusedComps)">removeRxns</a>(reducedModel,rxnsToDelete);
0140 
0141             <span class="comment">%Remove metabolites. Recalculate since it could be that some</span>
0142             <span class="comment">%cannot be deleted due to reserved rxns</span>
0143             notInUse=sum(reducedModel.S~=0,2)==0;
0144             deletedMetabolites=[deletedMetabolites; reducedModel.mets(notInUse)];
0145             reducedModel=<a href="removeMets.html" class="code" title="function reducedModel=removeMets(model,metsToRemove,isNames,removeUnusedRxns,removeUnusedGenes,removeUnusedComps)">removeMets</a>(reducedModel,notInUse);
0146             
0147             <span class="comment">%It could happen that it just finds reserved reactions and gets</span>
0148             <span class="comment">%stuck</span>
0149             <span class="keyword">if</span> ~isempty(rxnsToDelete)
0150                 deletedRxn=true;
0151             <span class="keyword">end</span>
0152         <span class="keyword">else</span>
0153             <span class="keyword">break</span>;
0154         <span class="keyword">end</span>
0155         <span class="keyword">if</span> deletedRxn==false
0156             <span class="keyword">break</span>;
0157         <span class="keyword">end</span>
0158     <span class="keyword">end</span>
0159 <span class="keyword">end</span>
0160 
0161 <span class="keyword">if</span> deleteMinMax==true
0162     <span class="comment">%Get reactions that can't carry fluxes. This should be done</span>
0163     <span class="comment">%algebraically if possible</span>
0164     I=~<a href="haveFlux.html" class="code" title="function I=haveFlux(model,cutOff,rxns)">haveFlux</a>(reducedModel);
0165     
0166     <span class="comment">%Remove reactions</span>
0167     rxnsToDelete=setdiff(reducedModel.rxns(I),reservedRxns);
0168     deletedReactions=[deletedReactions; rxnsToDelete];
0169     reducedModel=<a href="removeRxns.html" class="code" title="function reducedModel=removeRxns(model,rxnsToRemove,removeUnusedMets,removeUnusedGenes,removeUnusedComps)">removeRxns</a>(reducedModel,rxnsToDelete);
0170             
0171     <span class="comment">%Remove metabolites</span>
0172     notInUse=sum(reducedModel.S~=0,2)==0;
0173     deletedMetabolites=[deletedMetabolites; reducedModel.mets(notInUse)];
0174     reducedModel=<a href="removeMets.html" class="code" title="function reducedModel=removeMets(model,metsToRemove,isNames,removeUnusedRxns,removeUnusedGenes,removeUnusedComps)">removeMets</a>(reducedModel,notInUse);
0175 <span class="keyword">end</span>
0176 
0177 <span class="comment">%Checks that all reactions are irreversible. Might be fixed in the future.</span>
0178 <span class="keyword">if</span> groupLinear==true
0179     <span class="keyword">if</span> ~any(reducedModel.rev)
0180         <span class="keyword">if</span>  suppressWarnings==false
0181             fprintf(<span class="string">'NOTE: You have chosen to group linear reactions. This option does not keep track of gene/reaction associations when reactions are merged. Deleting all gene information\n'</span>);
0182         <span class="keyword">end</span>
0183         bannedIndexes=<a href="getIndexes.html" class="code" title="function indexes=getIndexes(model,objects, type, returnLogical)">getIndexes</a>(reducedModel,reservedRxns,<span class="string">'rxns'</span>);
0184         <span class="keyword">while</span> 1
0185             <span class="comment">%Select all metabolites that are only present as reactants/products</span>
0186             <span class="comment">%in one reaction</span>
0187             singleNegative=find(sum(reducedModel.S'&lt;0)==1);
0188             singlePositive=find(sum(reducedModel.S'&gt;0)==1);
0189    
0190             <span class="comment">%Retrieve the common metabolites</span>
0191             common=intersect(singleNegative,singlePositive);
0192             
0193             <span class="comment">%Merge the reactions for each of these metabolites</span>
0194             mergedSomeRxn=false;
0195             <span class="keyword">for</span> i=1:numel(common)
0196                 involvedRxns=find(reducedModel.S(common(i),:));
0197                 
0198                 <span class="comment">%Check so that it doesn't try to merge reactions that are</span>
0199                 <span class="comment">%restricted. The second check is needed because it could be</span>
0200                 <span class="comment">%that some of the metabolites have already been merged in</span>
0201                 <span class="comment">%this iteration so that the reactions no longer exist</span>
0202                 <span class="keyword">if</span> isempty(intersect(bannedIndexes,involvedRxns)) &amp;&amp; any(involvedRxns)
0203                     <span class="comment">%This is the ratio that described how many times the second</span>
0204                     <span class="comment">%reaction should be multiplied before being merged with</span>
0205                     <span class="comment">%the first</span>
0206                     stoichRatio=abs(reducedModel.S(common(i),involvedRxns(1))/reducedModel.S(common(i),involvedRxns(2)));
0207                     reducedModel.S(:,involvedRxns(1))=reducedModel.S(:,involvedRxns(1))+reducedModel.S(:,involvedRxns(2))*stoichRatio;
0208                     reducedModel.S(common(i),involvedRxns(1))=0;
0209                     
0210                     <span class="comment">%Change the name and id to reflect the merging</span>
0211                     reducedModel.rxns{involvedRxns(1)}=[reducedModel.rxns{involvedRxns(1)} <span class="string">'_'</span> reducedModel.rxns{involvedRxns(2)}];
0212                     reducedModel.rxnNames{involvedRxns(1)}=reducedModel.rxns{involvedRxns(1)};
0213                     
0214                     <span class="comment">%Remove the second reaction by setting all coefficients</span>
0215                     <span class="comment">%to 0</span>
0216                     reducedModel.S(:,involvedRxns(2))=0;
0217                     mergedSomeRxn=true;
0218                 <span class="keyword">end</span>
0219             <span class="keyword">end</span>
0220             
0221             <span class="comment">%If it couldn't merge anything then exit the loop</span>
0222             <span class="keyword">if</span> mergedSomeRxn==false
0223                 <span class="keyword">break</span>;
0224             <span class="keyword">end</span>
0225         <span class="keyword">end</span>
0226         
0227         <span class="comment">%Now delete all reactions that involve no metabolites</span>
0228         I=sum(reducedModel.S~=0)==0;
0229         
0230         <span class="comment">%Remove reactions</span>
0231         deletedReactions=[deletedReactions; reducedModel.rxns(I)];
0232         reducedModel=<a href="removeRxns.html" class="code" title="function reducedModel=removeRxns(model,rxnsToRemove,removeUnusedMets,removeUnusedGenes,removeUnusedComps)">removeRxns</a>(reducedModel,find(I));
0233             
0234         <span class="comment">%Remove metabolites</span>
0235         notInUse=sum(reducedModel.S~=0,2)==0;
0236         deletedMetabolites=[deletedMetabolites; reducedModel.mets(notInUse)];
0237         reducedModel=<a href="removeMets.html" class="code" title="function reducedModel=removeMets(model,metsToRemove,isNames,removeUnusedRxns,removeUnusedGenes,removeUnusedComps)">removeMets</a>(reducedModel,notInUse);
0238         
0239         reducedModel.genes={};
0240         reducedModel.rxnGeneMat=sparse(numel(reducedModel.rxns),0);
0241         reducedModel.grRules(:)={<span class="string">''</span>};
0242         
0243         <span class="keyword">if</span> isfield(reducedModel,<span class="string">'geneShortNames'</span>)
0244             reducedModel.geneShortNames={};
0245         <span class="keyword">end</span>
0246         <span class="keyword">if</span> isfield(reducedModel,<span class="string">'geneMiriams'</span>)
0247             reducedModel.geneMiriams={};
0248         <span class="keyword">end</span>
0249         <span class="keyword">if</span> isfield(reducedModel,<span class="string">'geneComps'</span>)
0250             reducedModel.geneComps=[];
0251         <span class="keyword">end</span>
0252     <span class="keyword">else</span>
0253         <a href="dispEM.html" class="code" title="function dispEM(string,throwErrors,toList,trimWarnings)">dispEM</a>(<span class="string">'Cannot group reactions for a model that has reversible reactions'</span>);
0254     <span class="keyword">end</span>
0255 <span class="keyword">end</span>
0256 
0257 <span class="keyword">end</span></pre></div>
<hr><address>Generated on Mon 06-Jan-2014 14:58:12 by <strong><a href="http://www.artefact.tk/software/matlab/m2html/" title="Matlab Documentation in HTML">m2html</a></strong> &copy; 2005</address>
</body>
</html>