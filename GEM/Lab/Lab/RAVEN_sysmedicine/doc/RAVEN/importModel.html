<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of importModel</title>
  <meta name="keywords" content="importModel">
  <meta name="description" content="importModel">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html v1.5 &copy; 2003-2005 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../m2html.css">
</head>
<body>
<a name="_top"></a>
<div><a href="../index.html">Home</a> &gt;  <a href="index.html">RAVEN</a> &gt; importModel.m</div>

<!--<table width="100%"><tr><td align="left"><a href="../index.html"><img alt="<" border="0" src="../left.png">&nbsp;Master index</a></td>
<td align="right"><a href="index.html">Index for RAVEN&nbsp;<img alt=">" border="0" src="../right.png"></a></td></tr></table>-->

<h1>importModel
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="box"><strong>importModel</strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="box"><strong>function model=importModel(fileName,removeExcMets,isCOBRA,supressWarnings) </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="fragment"><pre class="comment"> importModel
   Import a constraint-based model from a SBML file

   fileName        a SBML file to import
   removeExcMets   true if exchange metabolites should be removed. This is
                   needed to be able to run simulations, but it could also 
                   be done using simplifyModel at a later stage (opt,
                   default true)
   isCOBRA         true if the SBML-file is a COBRA Toolbox file (opt, default
                   false)
   supressWarnings true if warnings regarding the model structure should
                   be supressed (opt, default false)

   model
       description      description of model contents
       id               model ID
       rxns             reaction ids
       mets             metabolite ids
       S                stoichiometric matrix
       lb               lower bounds
       ub               upper bounds
       rev              reversibility vector
       c                objective coefficients
       b                equality constraints for the metabolite equations
       comps            compartment ids
       compNames        compartment names
       compOutside      the id (as in comps) for the compartment
                        surrounding each of the compartments
       compMiriams      structure with MIRIAM information about the
                        compartments
       rxnNames         reaction description
       rxnComps         compartments for reactions
       grRules          reaction to gene rules in text form
       rxnGeneMat       reaction-to-gene mapping in sparse matrix form
       subSystems       subsystem name for each reaction
       eccodes          EC-codes for the reactions
       rxnMiriams       structure with MIRIAM information about the reactions
       genes            list of all genes
       geneComps        compartments for reactions
       geneMiriams      structure with MIRIAM information about the genes
       metNames         metabolite description
       metComps         compartments for metabolites
       inchis           InChI-codes for metabolites
       metFormulas      metabolite chemical formula
       metMiriams       structure with MIRIAM information about the metabolites
       unconstrained    true if the metabolite is an exchange metabolite

   Loads models in the COBRA Toolbox format and in the format used in
   the yeast consensus reconstruction. The resulting structure is compatible
   with COBRA Toolbox. A number of consistency checks are performed in order
   to ensure that the model is valid. Take these warnings seriously and modify the
   model structure to solve them. The RAVEN Toolbox is made to function
   only on consistent models, and the only checks performed are when the
   model is imported. You can use exportToExcelFormat, modify the model in
   Microsoft Excel and then reimport it using importExcelModel (or remake
   the SBML file using SBMLFromExcel)

   NOTE: This script requires that libSBML is installed.
   
   NOTE: All IDs are assumed to be named C_, M_, E_, R_ for compartments, 
         metabolites, genes, and reactions. This is true for models
         generated by SBMLFromExcel and those that follow the yeast
         consensus network model formulation.

   Usage: model=importModel(fileName,removeExcMets,isCOBRA,supressWarnings)

   Rasmus Agren, 2013-08-06</pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../matlabicon.gif)">
<li><a href="checkModelStruct.html" class="code" title="function checkModelStruct(model,throwErrors,trimWarnings)">checkModelStruct</a>	checkModelStruct</li><li><a href="dispEM.html" class="code" title="function dispEM(string,throwErrors,toList,trimWarnings)">dispEM</a>	dispEM</li><li><a href="simplifyModel.html" class="code" title="function [reducedModel, deletedReactions, deletedMetabolites]=simplifyModel(model,deleteUnconstrained, deleteDuplicates, deleteZeroInterval, deleteInaccessible, deleteMinMax, groupLinear, reservedRxns, suppressWarnings)">simplifyModel</a>	simplifyModel</li></ul>
This function is called by:
<ul style="list-style-image:url(../matlabicon.gif)">
<li><a href="checkInstallation.html" class="code" title="function checkInstallation()">checkInstallation</a>	checkInstallation</li></ul>
<!-- crossreference -->

<h2><a name="_subfunctions"></a>SUBFUNCTIONS <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<ul style="list-style-image:url(../matlabicon.gif)">
<li><a href="#_sub1" class="code">function [rxnGeneMat, matchGenes]=getGeneMat(grRules,matchGenes)</a></li><li><a href="#_sub2" class="code">function miriamStruct=parseMiriam(searchString)</a></li></ul>

<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="fragment"><pre>0001 <a name="_sub0" href="#_subfunctions" class="code">function model=importModel(fileName,removeExcMets,isCOBRA,supressWarnings)</a>
0002 <span class="comment">% importModel</span>
0003 <span class="comment">%   Import a constraint-based model from a SBML file</span>
0004 <span class="comment">%</span>
0005 <span class="comment">%   fileName        a SBML file to import</span>
0006 <span class="comment">%   removeExcMets   true if exchange metabolites should be removed. This is</span>
0007 <span class="comment">%                   needed to be able to run simulations, but it could also</span>
0008 <span class="comment">%                   be done using simplifyModel at a later stage (opt,</span>
0009 <span class="comment">%                   default true)</span>
0010 <span class="comment">%   isCOBRA         true if the SBML-file is a COBRA Toolbox file (opt, default</span>
0011 <span class="comment">%                   false)</span>
0012 <span class="comment">%   supressWarnings true if warnings regarding the model structure should</span>
0013 <span class="comment">%                   be supressed (opt, default false)</span>
0014 <span class="comment">%</span>
0015 <span class="comment">%   model</span>
0016 <span class="comment">%       description      description of model contents</span>
0017 <span class="comment">%       id               model ID</span>
0018 <span class="comment">%       rxns             reaction ids</span>
0019 <span class="comment">%       mets             metabolite ids</span>
0020 <span class="comment">%       S                stoichiometric matrix</span>
0021 <span class="comment">%       lb               lower bounds</span>
0022 <span class="comment">%       ub               upper bounds</span>
0023 <span class="comment">%       rev              reversibility vector</span>
0024 <span class="comment">%       c                objective coefficients</span>
0025 <span class="comment">%       b                equality constraints for the metabolite equations</span>
0026 <span class="comment">%       comps            compartment ids</span>
0027 <span class="comment">%       compNames        compartment names</span>
0028 <span class="comment">%       compOutside      the id (as in comps) for the compartment</span>
0029 <span class="comment">%                        surrounding each of the compartments</span>
0030 <span class="comment">%       compMiriams      structure with MIRIAM information about the</span>
0031 <span class="comment">%                        compartments</span>
0032 <span class="comment">%       rxnNames         reaction description</span>
0033 <span class="comment">%       rxnComps         compartments for reactions</span>
0034 <span class="comment">%       grRules          reaction to gene rules in text form</span>
0035 <span class="comment">%       rxnGeneMat       reaction-to-gene mapping in sparse matrix form</span>
0036 <span class="comment">%       subSystems       subsystem name for each reaction</span>
0037 <span class="comment">%       eccodes          EC-codes for the reactions</span>
0038 <span class="comment">%       rxnMiriams       structure with MIRIAM information about the reactions</span>
0039 <span class="comment">%       genes            list of all genes</span>
0040 <span class="comment">%       geneComps        compartments for reactions</span>
0041 <span class="comment">%       geneMiriams      structure with MIRIAM information about the genes</span>
0042 <span class="comment">%       metNames         metabolite description</span>
0043 <span class="comment">%       metComps         compartments for metabolites</span>
0044 <span class="comment">%       inchis           InChI-codes for metabolites</span>
0045 <span class="comment">%       metFormulas      metabolite chemical formula</span>
0046 <span class="comment">%       metMiriams       structure with MIRIAM information about the metabolites</span>
0047 <span class="comment">%       unconstrained    true if the metabolite is an exchange metabolite</span>
0048 <span class="comment">%</span>
0049 <span class="comment">%   Loads models in the COBRA Toolbox format and in the format used in</span>
0050 <span class="comment">%   the yeast consensus reconstruction. The resulting structure is compatible</span>
0051 <span class="comment">%   with COBRA Toolbox. A number of consistency checks are performed in order</span>
0052 <span class="comment">%   to ensure that the model is valid. Take these warnings seriously and modify the</span>
0053 <span class="comment">%   model structure to solve them. The RAVEN Toolbox is made to function</span>
0054 <span class="comment">%   only on consistent models, and the only checks performed are when the</span>
0055 <span class="comment">%   model is imported. You can use exportToExcelFormat, modify the model in</span>
0056 <span class="comment">%   Microsoft Excel and then reimport it using importExcelModel (or remake</span>
0057 <span class="comment">%   the SBML file using SBMLFromExcel)</span>
0058 <span class="comment">%</span>
0059 <span class="comment">%   NOTE: This script requires that libSBML is installed.</span>
0060 <span class="comment">%</span>
0061 <span class="comment">%   NOTE: All IDs are assumed to be named C_, M_, E_, R_ for compartments,</span>
0062 <span class="comment">%         metabolites, genes, and reactions. This is true for models</span>
0063 <span class="comment">%         generated by SBMLFromExcel and those that follow the yeast</span>
0064 <span class="comment">%         consensus network model formulation.</span>
0065 <span class="comment">%</span>
0066 <span class="comment">%   Usage: model=importModel(fileName,removeExcMets,isCOBRA,supressWarnings)</span>
0067 <span class="comment">%</span>
0068 <span class="comment">%   Rasmus Agren, 2013-08-06</span>
0069 <span class="comment">%</span>
0070 
0071 <span class="keyword">if</span> nargin&lt;2
0072     removeExcMets=true;
0073 <span class="keyword">end</span>
0074 
0075 <span class="keyword">if</span> nargin&lt;3
0076     isCOBRA=false;
0077 <span class="keyword">end</span>
0078 
0079 <span class="keyword">if</span> nargin&lt;4
0080     supressWarnings=false;
0081 <span class="keyword">end</span>
0082 
0083 <span class="comment">%This is to match the order of the fields to those you get from importing</span>
0084 <span class="comment">%from Excel</span>
0085 model=[];
0086 model.description=[];
0087 model.id=[];
0088 model.annotation=[];
0089 model.rxns={};
0090 model.mets={};
0091 model.S=[];
0092 model.lb=[];
0093 model.ub=[];
0094 model.rev=[];
0095 model.c=[];
0096 model.b=[];
0097 model.comps={};
0098 model.compNames={};
0099 model.compOutside={};
0100 model.compMiriams={};
0101 model.rxnNames={};
0102 model.rxnComps=[];
0103 model.grRules={};
0104 model.rxnGeneMat=[];
0105 model.subSystems={};
0106 model.eccodes={};
0107 model.rxnMiriams={};
0108 model.genes={};
0109 model.geneComps=[];
0110 model.geneMiriams={};
0111 model.metNames={};
0112 model.metComps=[];
0113 model.inchis={};
0114 model.metFormulas={};
0115 model.metMiriams={};
0116 model.unconstrained=[];
0117 
0118 <span class="comment">%Load the model using libSBML</span>
0119 modelSBML = TranslateSBML(fileName);
0120 
0121 <span class="keyword">if</span> isempty(modelSBML)
0122    <a href="dispEM.html" class="code" title="function dispEM(string,throwErrors,toList,trimWarnings)">dispEM</a>(<span class="string">'There is a problem with the SBML file. Try using the SBML Validator at http://sbml.org/Facilities/Validator'</span>);
0123 <span class="keyword">end</span>
0124 
0125 <span class="comment">%Retrieve compartment names and IDs</span>
0126 compartmentNames=cell(numel(modelSBML.compartment),1);
0127 compartmentIDs=cell(numel(modelSBML.compartment),1);
0128 compartmentOutside=cell(numel(modelSBML.compartment),1);
0129 compartmentMiriams=cell(numel(modelSBML.compartment),1);
0130 
0131 <span class="keyword">for</span> i=1:numel(modelSBML.compartment)
0132     compartmentNames{i}=modelSBML.compartment(i).name;
0133     <span class="keyword">if</span> isCOBRA==true
0134         compartmentIDs{i}=modelSBML.compartment(i).id;
0135     <span class="keyword">else</span>
0136         compartmentIDs{i}=modelSBML.compartment(i).id(3:end);
0137     <span class="keyword">end</span>
0138     <span class="keyword">if</span> isfield(modelSBML.compartment(i),<span class="string">'outside'</span>)
0139         <span class="keyword">if</span> ~isempty(modelSBML.compartment(i).outside)
0140             <span class="keyword">if</span> isCOBRA==true
0141                 compartmentOutside{i}=modelSBML.compartment(i).outside;
0142             <span class="keyword">else</span>
0143                 compartmentOutside{i}=modelSBML.compartment(i).outside(3:end);
0144             <span class="keyword">end</span>
0145         <span class="keyword">else</span>
0146             compartmentOutside{i}=<span class="string">''</span>;
0147         <span class="keyword">end</span>
0148     <span class="keyword">else</span>
0149         compartmentOutside{i}=[];
0150     <span class="keyword">end</span>
0151     
0152     <span class="keyword">if</span> isfield(modelSBML.compartment(i),<span class="string">'annotation'</span>)
0153         compartmentMiriams{i}=<a href="#_sub2" class="code" title="subfunction miriamStruct=parseMiriam(searchString)">parseMiriam</a>(modelSBML.compartment(i).annotation);
0154     <span class="keyword">else</span>
0155         compartmentMiriams{i}=[];
0156     <span class="keyword">end</span>
0157 <span class="keyword">end</span>
0158 
0159 <span class="comment">%If there are no compartment names then use compartment id as name</span>
0160 <span class="keyword">if</span> all(cellfun(@isempty,compartmentNames))
0161     compartmentNames=compartmentIDs;
0162 <span class="keyword">end</span>
0163 
0164 <span class="comment">%Retrieve info on metabolites, genes, complexes</span>
0165 metaboliteNames={};
0166 metaboliteIDs={};
0167 metaboliteCompartments={};
0168 metaboliteUnconstrained=[];
0169 metaboliteFormula={};
0170 metaboliteInChI={};
0171 metaboliteMiriams={};
0172 
0173 geneNames={};
0174 geneIDs={};
0175 geneMiriams={};
0176 geneShortNames={};
0177 geneCompartments={};
0178 complexIDs={};
0179 complexNames={};
0180 
0181 <span class="comment">%If the file is not a COBRA Toolbox model. According to the format</span>
0182 <span class="comment">%specified in the yeast consensus model both metabolites and genes are a</span>
0183 <span class="comment">%type of 'species'. The metabolites have names starting with 'M_' and genes</span>
0184 <span class="comment">%with 'E_'.</span>
0185 <span class="keyword">if</span> isCOBRA==false
0186     <span class="keyword">for</span> i=1:numel(modelSBML.species) 
0187         <span class="keyword">if</span> strcmpi(modelSBML.species(i).id(1:2),<span class="string">'M_'</span>)
0188             metaboliteNames{numel(metaboliteNames)+1,1}=modelSBML.species(i).name;
0189             metaboliteIDs{numel(metaboliteIDs)+1,1}=modelSBML.species(i).id(3:end);
0190             metaboliteCompartments{numel(metaboliteCompartments)+1,1}=modelSBML.species(i).compartment(3:end);
0191             metaboliteUnconstrained(numel(metaboliteUnconstrained)+1,1)=modelSBML.species(i).boundaryCondition;
0192 
0193             <span class="comment">%For each metabolite retrieve the formula and the InChI code if</span>
0194             <span class="comment">%available</span>
0195             <span class="comment">%First add the InChI code and the formula from the InChI. This</span>
0196             <span class="comment">%allows for overwriting the formula by setting the actual formula</span>
0197             <span class="comment">%field</span>
0198             <span class="keyword">if</span> ~isempty(modelSBML.species(i).annotation)
0199                 <span class="comment">%Get the formula if available</span>
0200                 startString=<span class="string">'&gt;InChI='</span>;
0201                 endString=<span class="string">'&lt;/in:inchi&gt;'</span>;
0202                 formStart=strfind(modelSBML.species(i).annotation,startString);
0203                 <span class="keyword">if</span> ~isempty(formStart)
0204                     formEnd=strfind(modelSBML.species(i).annotation,endString);
0205                     formEndIndex=find(formEnd&gt;formStart, 1 );
0206                     formula=modelSBML.species(i).annotation(formStart+numel(startString):formEnd(formEndIndex)-1);
0207                     metaboliteInChI{numel(metaboliteInChI)+1,1}=formula;
0208 
0209                     <span class="comment">%The composition is most often present between the first</span>
0210                     <span class="comment">%and second &quot;/&quot; in the model. In some simple molecules,</span>
0211                     <span class="comment">%such as salts, there is no second &quot;/&quot;. The formula is then</span>
0212                     <span class="comment">%assumed to be to the end of the string</span>
0213                     compositionIndexes=strfind(formula,<span class="string">'/'</span>);
0214                     <span class="keyword">if</span> numel(compositionIndexes)&gt;1
0215                         metaboliteFormula{numel(metaboliteFormula)+1,1}=<span class="keyword">...</span>
0216                             formula(compositionIndexes(1)+1:compositionIndexes(2)-1);
0217                     <span class="keyword">else</span>
0218                         <span class="keyword">if</span> numel(compositionIndexes)==1
0219                             <span class="comment">%Probably a simple molecule which can have only one</span>
0220                             <span class="comment">%conformation</span>
0221                             metaboliteFormula{numel(metaboliteFormula)+1,1}=<span class="keyword">...</span>
0222                             formula(compositionIndexes(1)+1:numel(formula));
0223                         <span class="keyword">else</span>
0224                             metaboliteFormula{numel(metaboliteFormula)+1,1}=<span class="string">''</span>;
0225                         <span class="keyword">end</span>
0226                     <span class="keyword">end</span>
0227                 <span class="keyword">else</span>
0228                     metaboliteInChI{numel(metaboliteInChI)+1,1}=<span class="string">''</span>;
0229                     metaboliteFormula{numel(metaboliteFormula)+1,1}=<span class="string">''</span>;
0230                 <span class="keyword">end</span>
0231                 
0232                 <span class="comment">%Get Miriam info</span>
0233                 metMiriam=<a href="#_sub2" class="code" title="subfunction miriamStruct=parseMiriam(searchString)">parseMiriam</a>(modelSBML.species(i).annotation);
0234                 metaboliteMiriams{numel(metaboliteMiriams)+1,1}=metMiriam;
0235             <span class="keyword">else</span>
0236                 metaboliteInChI{numel(metaboliteInChI)+1,1}=<span class="string">''</span>;
0237                 metaboliteFormula{numel(metaboliteFormula)+1,1}=<span class="string">''</span>;
0238                 metaboliteMiriams{numel(metaboliteMiriams)+1,1}=[];
0239             <span class="keyword">end</span>
0240 
0241             <span class="keyword">if</span> ~isempty(modelSBML.species(i).notes)
0242                 <span class="comment">%Get the formula if available</span>
0243                 startString=<span class="string">'FORMULA:'</span>;
0244                 endString=<span class="string">'&lt;/'</span>;
0245                 formStart=strfind(modelSBML.species(i).notes,startString);
0246                 <span class="keyword">if</span> ~isempty(formStart)
0247                     formEnd=strfind(modelSBML.species(i).notes,endString);
0248                     formEndIndex=find(formEnd&gt;formStart, 1 );
0249                     formula=strtrim(modelSBML.species(i).notes(formStart+numel(startString):formEnd(formEndIndex)-1));
0250                     metaboliteFormula{numel(metaboliteFormula),1}=formula;
0251                 <span class="keyword">end</span>
0252             <span class="keyword">end</span>
0253         <span class="keyword">end</span>
0254 
0255         <span class="keyword">if</span> strcmpi(modelSBML.species(i).id(1:2),<span class="string">'E_'</span>)
0256             geneNames{numel(geneNames)+1,1}=modelSBML.species(i).name;
0257             
0258             <span class="comment">%The &quot;E_&quot; is included in the ID. This is because it's only used</span>
0259             <span class="comment">%internally in this file and it makes the matching a little</span>
0260             <span class="comment">%smoother</span>
0261             geneIDs{numel(geneIDs)+1,1}=modelSBML.species(i).id;
0262             geneCompartments{numel(geneCompartments)+1,1}=modelSBML.species(i).compartment(3:end);
0263 
0264             <span class="comment">%Get Miriam structure</span>
0265             <span class="keyword">if</span> isfield(modelSBML.species(i),<span class="string">'annotation'</span>)
0266                 <span class="comment">%Get Miriam info</span>
0267                 geneMiriam=<a href="#_sub2" class="code" title="subfunction miriamStruct=parseMiriam(searchString)">parseMiriam</a>(modelSBML.species(i).annotation);
0268                 geneMiriams{numel(geneMiriams)+1,1}=geneMiriam;
0269             <span class="keyword">else</span>
0270                 geneMiriams{numel(geneMiriams)+1,1}=[];
0271             <span class="keyword">end</span>
0272             
0273             <span class="comment">%Protein short names (for example ERG10) are saved as SHORT</span>
0274             <span class="comment">%NAME: NAME in the notes-section of metabolites for the &quot;new</span>
0275             <span class="comment">%format&quot; and as PROTEIN_ASSOCIATION for each reaction in COBRA</span>
0276             <span class="comment">%Toolbox format. For now only the SHORT NAME is loaded, and no</span>
0277             <span class="comment">%mapping takes place</span>
0278             <span class="keyword">if</span> ~isempty(modelSBML.species(i).notes)
0279                 <span class="comment">%Get the short name if available</span>
0280                 startString=<span class="string">'SHORT NAME:'</span>;
0281                 endString=<span class="string">'&lt;/'</span>;
0282                 shortStart=strfind(modelSBML.species(i).notes,startString);
0283                 <span class="keyword">if</span> ~isempty(shortStart)
0284                     shortEnd=strfind(modelSBML.species(i).notes,endString);
0285                     shortEndIndex=find(shortEnd&gt;shortStart, 1 );
0286                     shortName=strtrim(modelSBML.species(i).notes(shortStart+numel(startString):shortEnd(shortEndIndex)-1));
0287                     geneShortNames{numel(geneShortNames)+1,1}=shortName;
0288                 <span class="keyword">else</span>
0289                     geneShortNames{numel(geneShortNames)+1,1}=<span class="string">''</span>;
0290                 <span class="keyword">end</span>
0291             <span class="keyword">else</span>
0292                 geneShortNames{numel(geneShortNames)+1,1}=<span class="string">''</span>;
0293             <span class="keyword">end</span>
0294         <span class="keyword">end</span>
0295         
0296         <span class="comment">%If it's a complex keep the ID and name</span>
0297         <span class="keyword">if</span> strcmpi(modelSBML.species(i).id(1:3),<span class="string">'Cx_'</span>)
0298             complexIDs=[complexIDs;modelSBML.species(i).id];
0299             complexNames=[complexNames;modelSBML.species(i).name];
0300         <span class="keyword">end</span>        
0301     <span class="keyword">end</span>
0302     
0303 <span class="comment">%If it's a COBRA Toolbox file</span>
0304 <span class="keyword">else</span>
0305     <span class="keyword">for</span> i=1:numel(modelSBML.species) 
0306         <span class="comment">%The metabolite names are assumed to be M_NAME_COMPOSITION or</span>
0307         <span class="comment">%_NAME_COMPOSITION or NAME_COMPOSITION or NAME</span>
0308         underscoreIndex=strfind(modelSBML.species(i).name,<span class="string">'_'</span>);
0309 
0310         <span class="comment">%Skip the first character if it's an underscore</span>
0311         <span class="keyword">if</span> any(underscoreIndex)
0312             <span class="keyword">if</span> underscoreIndex(1)==1
0313                 metaboliteNames{numel(metaboliteNames)+1,1}=modelSBML.species(i).name(2:max(underscoreIndex)-1);
0314             <span class="keyword">else</span>
0315                 <span class="comment">%If the second character is an underscore than check if the</span>
0316                 <span class="comment">%first is &quot;M&quot;.</span>
0317                 <span class="keyword">if</span> underscoreIndex(1)==2
0318                     <span class="keyword">if</span> modelSBML.species(i).name(1)==<span class="string">'M'</span>
0319                         metaboliteNames{numel(metaboliteNames)+1,1}=modelSBML.species(i).name(3:max(underscoreIndex)-1);
0320                     <span class="keyword">else</span>
0321                         <span class="comment">%If not, then use the full name</span>
0322                         metaboliteNames{numel(metaboliteNames)+1,1}=modelSBML.species(i).name(1:max(underscoreIndex)-1);
0323                     <span class="keyword">end</span>
0324                 <span class="keyword">else</span>
0325                     <span class="comment">%Use the full name</span>
0326                     metaboliteNames{numel(metaboliteNames)+1,1}=modelSBML.species(i).name(1:max(underscoreIndex)-1);
0327                 <span class="keyword">end</span>
0328             <span class="keyword">end</span>
0329         <span class="keyword">else</span>
0330             <span class="comment">%Use the full name</span>
0331             metaboliteNames{numel(metaboliteNames)+1,1}=modelSBML.species(i).name;
0332         <span class="keyword">end</span>
0333         
0334         metaboliteIDs{numel(metaboliteIDs)+1,1}=modelSBML.species(i).id(3:numel(modelSBML.species(i).id));
0335         metaboliteCompartments{numel(metaboliteCompartments)+1,1}=modelSBML.species(i).compartment;
0336         
0337         <span class="comment">%I think that COBRA doesn't set the boundary condition, but rather</span>
0338         <span class="comment">%uses name_b. Check for either</span>
0339         metaboliteUnconstrained(numel(metaboliteUnconstrained)+1,1)=modelSBML.species(i).boundaryCondition;
0340         <span class="keyword">if</span> strcmp(metaboliteIDs{end}(max(end-1,1):end),<span class="string">'_b'</span>)
0341             metaboliteUnconstrained(end)=1;
0342         <span class="keyword">end</span>
0343         
0344         <span class="comment">%Get the formula</span>
0345         <span class="keyword">if</span> max(underscoreIndex)&lt;length(modelSBML.species(i).name)
0346             metaboliteFormula{numel(metaboliteFormula)+1,1}=modelSBML.species(i).name(max(underscoreIndex)+1:length(modelSBML.species(i).name));
0347         <span class="keyword">else</span>
0348             metaboliteFormula{numel(metaboliteFormula)+1,1}=<span class="string">''</span>;
0349         <span class="keyword">end</span>
0350         
0351         <span class="comment">%The newer COBRA version sometimes has composition information in</span>
0352         <span class="comment">%the notes instead</span>
0353         <span class="keyword">if</span> ~isempty(modelSBML.species(i).notes)
0354             <span class="comment">%Get the formula if available</span>
0355             startString=<span class="string">'FORMULA:'</span>;
0356             endString=<span class="string">'&lt;/'</span>;
0357             formStart=strfind(modelSBML.species(i).notes,startString);
0358             <span class="keyword">if</span> ~isempty(formStart)
0359                 formEnd=strfind(modelSBML.species(i).notes,endString);
0360                 formEndIndex=find(formEnd&gt;formStart, 1 );
0361                 formula=strtrim(modelSBML.species(i).notes(formStart+numel(startString):formEnd(formEndIndex)-1));
0362                 metaboliteFormula{numel(metaboliteFormula),1}=formula;
0363             <span class="keyword">end</span>
0364         <span class="keyword">end</span>
0365     <span class="keyword">end</span>
0366 <span class="keyword">end</span>
0367 
0368 <span class="comment">%Retrieve info on reactions</span>
0369 reactionNames=cell(numel(modelSBML.reaction),1);
0370 reactionIDs=cell(numel(modelSBML.reaction),1);
0371 subsystems=cell(numel(modelSBML.reaction),1);
0372 subsystems(:,:)=cellstr(<span class="string">''</span>);
0373 eccodes=cell(numel(modelSBML.reaction),1);
0374 eccodes(:,:)=cellstr(<span class="string">''</span>);
0375 grRules=cell(numel(modelSBML.reaction),1);
0376 grRules(:,:)=cellstr(<span class="string">''</span>);
0377 rxnComps=zeros(numel(modelSBML.reaction),1);
0378 rxnMiriams=cell(numel(modelSBML.reaction),1);
0379 reactionReversibility=zeros(numel(modelSBML.reaction),1);
0380 reactionUB=zeros(numel(modelSBML.reaction),1);
0381 reactionLB=zeros(numel(modelSBML.reaction),1);
0382 reactionObjective=zeros(numel(modelSBML.reaction),1);
0383 
0384 <span class="comment">%Construct the stoichiometric matrix while the reaction info is read</span>
0385 S=zeros(numel(metaboliteIDs),numel(modelSBML.reaction));
0386 
0387 <span class="comment">%This is for collecting all genes before getting a unique list (only used</span>
0388 <span class="comment">%in the COBRA format). The reason is to avoid too many calls to strmatch</span>
0389 tempGeneList={};
0390 
0391 counter=0;
0392 <span class="keyword">for</span> i=1:numel(modelSBML.reaction)
0393     
0394     <span class="comment">%Check that the reaction doesn't produce a complex and nothing else.</span>
0395     <span class="comment">%If so, then jump to the next reaction. This is because I get the</span>
0396     <span class="comment">%genes for complexes from the names and not from the reactions that</span>
0397     <span class="comment">%create them. This only applies to the non-COBRA format.</span>
0398     <span class="keyword">if</span> numel(modelSBML.reaction(i).product)==1
0399         <span class="keyword">if</span> strcmp(modelSBML.reaction(i).product(1).species(1:3),<span class="string">'Cx_'</span>)==true
0400             <span class="keyword">continue</span>;
0401         <span class="keyword">end</span>
0402     <span class="keyword">end</span>
0403     
0404     <span class="comment">%It didn't look like a gene complex-forming reaction</span>
0405     counter=counter+1;
0406     
0407     <span class="keyword">if</span> isCOBRA &amp;&amp; numel(modelSBML.reaction(i).name)&gt;2
0408         <span class="comment">%In COBRA the reaction names starts with &quot;R_&quot; but I check to be</span>
0409         <span class="comment">%sure</span>
0410         <span class="keyword">if</span> strcmp(modelSBML.reaction(i).name(1:2),<span class="string">'R_'</span>)
0411             reactionNames{counter}=modelSBML.reaction(i).name(3:end);
0412         <span class="keyword">else</span>
0413             reactionNames{counter}=modelSBML.reaction(i).name;
0414         <span class="keyword">end</span>
0415     <span class="keyword">else</span>
0416         reactionNames{counter}=modelSBML.reaction(i).name;
0417     <span class="keyword">end</span>
0418     
0419     <span class="comment">%Assumes that the ID starts with &quot;R_&quot;</span>
0420     reactionIDs{counter}=modelSBML.reaction(i).id(3:end);
0421     reactionReversibility(counter)=modelSBML.reaction(i).reversible;
0422     
0423     <span class="comment">%The order of these parameters should not be hard coded</span>
0424     <span class="keyword">if</span> isfield(modelSBML.reaction(i).kineticLaw,<span class="string">'parameter'</span>)
0425         reactionLB(counter)=modelSBML.reaction(i).kineticLaw.parameter(1).value;
0426         reactionUB(counter)=modelSBML.reaction(i).kineticLaw.parameter(2).value;
0427         reactionObjective(counter)=modelSBML.reaction(i).kineticLaw.parameter(3).value;
0428     <span class="keyword">else</span>
0429         <span class="keyword">if</span> reactionReversibility(counter)==true
0430             reactionLB(counter)=-inf;
0431         <span class="keyword">else</span>
0432             reactionLB(counter)=0;
0433         <span class="keyword">end</span>
0434         reactionUB(counter)=inf;
0435         reactionObjective(counter)=0;
0436     <span class="keyword">end</span>
0437     
0438     <span class="comment">%Find the associated gene if available</span>
0439     <span class="keyword">if</span> isCOBRA==false
0440         <span class="keyword">if</span> isfield(modelSBML.reaction(i),<span class="string">'modifier'</span>)
0441             <span class="keyword">if</span> ~isempty(modelSBML.reaction(i).modifier)
0442                 rules=<span class="string">''</span>;
0443                 <span class="keyword">for</span> j=1:numel(modelSBML.reaction(i).modifier)
0444                     modifier=modelSBML.reaction(i).modifier(j).species;
0445                     <span class="keyword">if</span> ~isempty(modifier)
0446                         <span class="keyword">if</span> strfind(modifier,<span class="string">'E_'</span>)
0447                             index=find(strcmp(modifier,geneIDs));
0448                             <span class="comment">%This should be unique and in the geneIDs list, otherwise</span>
0449                             <span class="comment">%something is wrong</span>
0450                             <span class="keyword">if</span> numel(index)~=1
0451                                <a href="dispEM.html" class="code" title="function dispEM(string,throwErrors,toList,trimWarnings)">dispEM</a>([<span class="string">'Could not get the gene association data from reaction '</span> reactionIDs{i}]); 
0452                             <span class="keyword">end</span>
0453                             <span class="comment">%Add the association</span>
0454                             <span class="comment">%rxnGeneMat(i,index)=1;</span>
0455                             <span class="keyword">if</span> ~isempty(rules)
0456                                 rules=[rules <span class="string">' or ('</span> geneNames{index} <span class="string">')'</span>];
0457                             <span class="keyword">else</span>
0458                                 rules=[<span class="string">'('</span> geneNames{index} <span class="string">')'</span>];
0459                             <span class="keyword">end</span>
0460                         <span class="keyword">else</span>
0461                            <span class="comment">%It seems to be a complex. Add the corresponding</span>
0462                            <span class="comment">%genes from the name of the complex (not the</span>
0463                            <span class="comment">%reaction that creates it)</span>
0464                            index=find(strcmp(modifier,complexIDs));
0465                            <span class="keyword">if</span> numel(index)==1
0466                                <span class="keyword">if</span> ~isempty(rules)
0467                                     rules=[rules <span class="string">' or ('</span> strrep(complexNames{index},<span class="string">':'</span>,<span class="string">' and '</span>) <span class="string">')'</span>];
0468                                 <span class="keyword">else</span>
0469                                     rules=[<span class="string">'('</span> strrep(complexNames{index},<span class="string">':'</span>,<span class="string">' and '</span>) <span class="string">')'</span>];
0470                                <span class="keyword">end</span>
0471                            <span class="keyword">else</span>
0472                               <span class="comment">%Could not find a complex</span>
0473                               <a href="dispEM.html" class="code" title="function dispEM(string,throwErrors,toList,trimWarnings)">dispEM</a>([<span class="string">'Could not get the gene association data from reaction '</span> reactionIDs{i}]);
0474                            <span class="keyword">end</span>
0475                         <span class="keyword">end</span>
0476                     <span class="keyword">end</span>
0477                 <span class="keyword">end</span>
0478                 grRules{counter}=rules;
0479             <span class="keyword">end</span>
0480         <span class="keyword">end</span>
0481     <span class="keyword">else</span>
0482         <span class="comment">%Get gene association for COBRA Toolbox models. The genes are added</span>
0483         <span class="comment">%here as well as the associations. Gene complexes are ok, but only</span>
0484         <span class="comment">%if they are on the form (A and B and...)</span>
0485         <span class="keyword">if</span> ~isempty(modelSBML.reaction(i).notes)
0486             startString=<span class="string">'GENE_ASSOCIATION:'</span>;
0487             endString=<span class="string">'&lt;/'</span>;
0488             geneStart=strfind(modelSBML.reaction(i).notes,startString);
0489             <span class="keyword">if</span> isempty(geneStart)
0490                 startString=<span class="string">'GENE ASSOCIATION:'</span>;
0491                 geneStart=strfind(modelSBML.reaction(i).notes,startString);
0492             <span class="keyword">end</span>
0493             <span class="keyword">if</span> ~isempty(geneStart)
0494                 geneEnd=strfind(modelSBML.reaction(i).notes,endString);
0495                 geneEndIndex=find(geneEnd&gt;geneStart, 1 );
0496                 geneAssociation=strtrim(modelSBML.reaction(i).notes(geneStart+numel(startString):geneEnd(geneEndIndex)-1));          
0497                 <span class="keyword">if</span> ~isempty(geneAssociation)
0498                     <span class="comment">%This adds the grRules. The gene list and rxnGeneMat</span>
0499                     <span class="comment">%are created later</span>
0500                     grRules{counter}=geneAssociation;
0501                 <span class="keyword">end</span>
0502             <span class="keyword">end</span>
0503         <span class="keyword">end</span>
0504     <span class="keyword">end</span>
0505     
0506     <span class="comment">%Add subsystems and reaction compartment</span>
0507     <span class="keyword">if</span> ~isempty(modelSBML.reaction(i).notes)
0508         <span class="comment">%Get the subsystem if available</span>
0509         startString=<span class="string">'SUBSYSTEM:'</span>;
0510         endString=<span class="string">'&lt;/'</span>;
0511         subStart=strfind(modelSBML.reaction(i).notes,startString);
0512         <span class="keyword">if</span> ~isempty(subStart)
0513             subEnd=strfind(modelSBML.reaction(i).notes,endString);
0514             subEndIndex=find(subEnd&gt;subStart, 1 );
0515             subsystem=strtrim(modelSBML.reaction(i).notes(subStart+numel(startString):subEnd(subEndIndex)-1));
0516             subsystems{counter}=subsystem;
0517         <span class="keyword">end</span>
0518         startString=<span class="string">'COMPARTMENT:'</span>;
0519         endString=<span class="string">'&lt;/'</span>;
0520         compStart=strfind(modelSBML.reaction(i).notes,startString);
0521         <span class="keyword">if</span> ~isempty(compStart)
0522             compEnd=strfind(modelSBML.reaction(i).notes,endString);
0523             compEndIndex=find(compEnd&gt;compStart, 1 );
0524             rxnComp=strtrim(modelSBML.reaction(i).notes(compStart+numel(startString):compEnd(compEndIndex)-1));
0525             <span class="comment">%Find it in the compartment list</span>
0526             [crap J]=ismember(rxnComp,compartmentIDs);
0527             rxnComps(counter)=J;
0528         <span class="keyword">end</span>
0529     <span class="keyword">end</span>
0530     
0531     <span class="comment">%Get ec-codes</span>
0532     flagEmpty=false;
0533     <span class="keyword">if</span> isCOBRA==false
0534         <span class="keyword">if</span> ~isempty(modelSBML.reaction(i).annotation)
0535             searchString=modelSBML.reaction(i).annotation;
0536             startString=<span class="string">'urn:miriam:ec-code:'</span>;
0537             endString=<span class="string">'&quot;'</span>;
0538         <span class="keyword">else</span>
0539             flagEmpty=true;
0540         <span class="keyword">end</span>
0541     <span class="keyword">else</span>
0542         <span class="keyword">if</span> ~isempty(modelSBML.reaction(i).notes)
0543             searchString=modelSBML.reaction(i).notes;
0544             startString=<span class="string">'PROTEIN_CLASS:'</span>;
0545             endString=<span class="string">'&lt;/'</span>;
0546         <span class="keyword">else</span>
0547             flagEmpty=true;
0548         <span class="keyword">end</span>
0549     <span class="keyword">end</span>
0550     
0551     <span class="keyword">if</span> flagEmpty==false
0552         ecStart=strfind(searchString,startString);
0553         ecEnd=strfind(searchString,endString);
0554         <span class="comment">%There can be several ec-codes, but they should be merged to one</span>
0555         <span class="comment">%string</span>
0556         <span class="keyword">for</span> j=1:numel(ecStart)
0557             ecEndIndex=find(ecEnd&gt;ecStart(j), 1 );
0558             eccode=strtrim(searchString(ecStart(j)+numel(startString):ecEnd(ecEndIndex)-1));
0559             <span class="keyword">if</span> j==1
0560                 eccodes{counter}=eccode;
0561             <span class="keyword">else</span>
0562                 eccodes{counter}=[eccodes{counter} <span class="string">';'</span> eccode];
0563             <span class="keyword">end</span>
0564         <span class="keyword">end</span>
0565     <span class="keyword">end</span> 
0566  
0567     <span class="comment">%Get other Miriam fields. This may include for example database indexes</span>
0568     <span class="comment">%to organism-specific databases. EC-codes are supported by the COBRA</span>
0569     <span class="comment">%Toolbox format and are therefore loaded separately</span>
0570     <span class="keyword">if</span> isCOBRA==false
0571         miriamStruct=<a href="#_sub2" class="code" title="subfunction miriamStruct=parseMiriam(searchString)">parseMiriam</a>(modelSBML.reaction(i).annotation);
0572         rxnMiriams{counter}=miriamStruct; 
0573     <span class="keyword">end</span>
0574     
0575     <span class="comment">%Add all reactants</span>
0576     <span class="keyword">for</span> j=1:numel(modelSBML.reaction(i).reactant)
0577        <span class="comment">%Get the index of the metabolite in metaboliteIDs. External</span>
0578        <span class="comment">%metabolites will be removed at a later stage</span>
0579        <span class="comment">%Assumes that all metabolites start with &quot;M_&quot;</span>
0580        metIndex=find(strcmp(modelSBML.reaction(i).reactant(j).species(3:end),metaboliteIDs),1);
0581        <span class="keyword">if</span> isempty(metIndex)
0582             <a href="dispEM.html" class="code" title="function dispEM(string,throwErrors,toList,trimWarnings)">dispEM</a>([<span class="string">'Could not find metabolite '</span> modelSBML.reaction(i).reactant(j).species(3:end) <span class="string">' in reaction '</span> reactionIDs{counter}]); 
0583        <span class="keyword">end</span>
0584        S(metIndex,counter)=S(metIndex,counter)+modelSBML.reaction(i).reactant(j).stoichiometry*-1;
0585     <span class="keyword">end</span>
0586     
0587     <span class="comment">%Add all products</span>
0588     <span class="keyword">for</span> j=1:numel(modelSBML.reaction(i).product)
0589        <span class="comment">%Get the index of the metabolite in metaboliteIDs.</span>
0590        <span class="comment">%Assumes that all metabolites start with &quot;M_&quot;</span>
0591        metIndex=find(strcmp(modelSBML.reaction(i).product(j).species(3:end),metaboliteIDs),1);
0592        <span class="keyword">if</span> isempty(metIndex)
0593             <a href="dispEM.html" class="code" title="function dispEM(string,throwErrors,toList,trimWarnings)">dispEM</a>([<span class="string">'Could not find metabolite '</span> modelSBML.reaction(i).reactant(j).species(3:end) <span class="string">' in reaction '</span> reactionIDs{counter}]); 
0594        <span class="keyword">end</span>
0595        S(metIndex,counter)=S(metIndex,counter)+modelSBML.reaction(i).product(j).stoichiometry;
0596     <span class="keyword">end</span>
0597 <span class="keyword">end</span>
0598 
0599 <span class="comment">%Shrink the structures if complex-forming reactions had to be skipped</span>
0600 reactionNames=reactionNames(1:counter);
0601 reactionIDs=reactionIDs(1:counter);
0602 subsystems=subsystems(1:counter);
0603 eccodes=eccodes(1:counter);
0604 grRules=grRules(1:counter);
0605 rxnMiriams=rxnMiriams(1:counter);
0606 reactionReversibility=reactionReversibility(1:counter);
0607 reactionUB=reactionUB(1:counter);
0608 reactionLB=reactionLB(1:counter);
0609 reactionObjective=reactionObjective(1:counter);
0610 S=S(:,1:counter);
0611 
0612 model.description=modelSBML.name;
0613 model.id=modelSBML.id;
0614 model.rxns=reactionIDs;
0615 model.mets=metaboliteIDs;
0616 model.S=sparse(S);
0617 model.lb=reactionLB;
0618 model.ub=reactionUB;
0619 model.rev=reactionReversibility;
0620 model.c=reactionObjective;
0621 model.b=zeros(numel(metaboliteIDs),1);
0622 model.comps=compartmentIDs;
0623 model.compNames=compartmentNames;
0624 
0625 <span class="comment">%Load annotation if available</span>
0626 <span class="keyword">if</span> isfield(modelSBML,<span class="string">'annotation'</span>)
0627     endString=<span class="string">'&lt;/'</span>;
0628     I=strfind(modelSBML.annotation,endString);
0629     J=strfind(modelSBML.annotation,<span class="string">'&lt;vCard:Family&gt;'</span>);
0630     <span class="keyword">if</span> any(J)
0631        model.annotation.familyName=modelSBML.annotation(J+14:I(find(I&gt;J,1))-1);
0632     <span class="keyword">end</span>
0633     J=strfind(modelSBML.annotation,<span class="string">'&lt;vCard:Given&gt;'</span>);
0634     <span class="keyword">if</span> any(J)
0635        model.annotation.givenName=modelSBML.annotation(J+13:I(find(I&gt;J,1))-1);
0636     <span class="keyword">end</span>
0637     J=strfind(modelSBML.annotation,<span class="string">'&lt;vCard:EMAIL&gt;'</span>);
0638     <span class="keyword">if</span> any(J)
0639        model.annotation.email=modelSBML.annotation(J+13:I(find(I&gt;J,1))-1);
0640     <span class="keyword">end</span>
0641     J=strfind(modelSBML.annotation,<span class="string">'&lt;vCard:Orgname&gt;'</span>);
0642     <span class="keyword">if</span> any(J)
0643        model.annotation.organization=modelSBML.annotation(J+15:I(find(I&gt;J,1))-1);
0644     <span class="keyword">end</span>
0645     endString=<span class="string">'&quot;/&gt;'</span>;
0646     I=strfind(modelSBML.annotation,endString);
0647     J=strfind(modelSBML.annotation,<span class="string">'&quot;urn:miriam:'</span>);
0648     <span class="keyword">if</span> any(J)
0649        model.annotation.taxonomy=modelSBML.annotation(J+12:I(find(I&gt;J,1))-1);
0650     <span class="keyword">end</span>
0651 <span class="keyword">end</span>
0652 <span class="keyword">if</span> isfield(modelSBML,<span class="string">'notes'</span>)
0653     startString=strfind(modelSBML.notes,<span class="string">'xhtml&quot;&gt;'</span>);
0654     endString=strfind(modelSBML.notes,<span class="string">'&lt;/body&gt;'</span>);
0655     <span class="keyword">if</span> any(startString) &amp;&amp; any(endString)
0656        model.annotation.note=modelSBML.notes(startString+7:endString-1);
0657     <span class="keyword">end</span>
0658 <span class="keyword">end</span>
0659 
0660 <span class="keyword">if</span> any(~cellfun(@isempty,compartmentOutside))
0661     model.compOutside=compartmentOutside;
0662 <span class="keyword">end</span>
0663 
0664 model.rxnNames=reactionNames;
0665 model.metNames=metaboliteNames;
0666 
0667 <span class="comment">%Match the compartments for metabolites</span>
0668 [I J]=ismember(metaboliteCompartments,model.comps);
0669 model.metComps=J;
0670 
0671 <span class="comment">%If any genes have been loaded (only for the new format)</span>
0672 <span class="keyword">if</span> ~isempty(geneNames)
0673     model.genes=geneNames;
0674     model.rxnGeneMat=<a href="#_sub1" class="code" title="subfunction [rxnGeneMat, matchGenes]=getGeneMat(grRules,matchGenes)">getGeneMat</a>(grRules,geneNames);
0675     model.grRules=grRules;
0676     <span class="comment">%Match the compartments for genes</span>
0677     [I J]=ismember(geneCompartments,model.comps);
0678     model.geneComps=J;
0679 <span class="keyword">else</span>
0680     <span class="keyword">if</span> ~isempty(grRules)
0681        grRules=strrep(grRules,<span class="string">' AND '</span>,<span class="string">' and '</span>);
0682        grRules=strrep(grRules,<span class="string">' OR '</span>,<span class="string">' or '</span>);
0683        <span class="comment">%In the non-COBRA version genes are surrounded by parenthesis even</span>
0684        <span class="comment">%if they are the only gene. Also, only single spaces are used</span>
0685        <span class="comment">%between genes. I'm pretty sure this is compatible with COBRA Toolbox so I</span>
0686        <span class="comment">%change it to be the same here.</span>
0687        grRules=strrep(grRules,<span class="string">'  '</span>,<span class="string">' '</span>);
0688        grRules=strrep(grRules,<span class="string">'(('</span>,<span class="string">'('</span>);
0689        grRules=strrep(grRules,<span class="string">'))'</span>,<span class="string">')'</span>);
0690        grRules=strrep(grRules,<span class="string">'( '</span>,<span class="string">'('</span>);
0691        grRules=strrep(grRules,<span class="string">' )'</span>,<span class="string">')'</span>);
0692        grRules=strrep(grRules,<span class="string">') or ('</span>,<span class="string">'*%%%%*'</span>);
0693        grRules=strrep(grRules,<span class="string">' or '</span>,<span class="string">') or ('</span>);
0694        grRules=strrep(grRules,<span class="string">'*%%%%*'</span>,<span class="string">') or ('</span>);
0695        
0696        <span class="comment">%Not very neat, but add parenthesis if missing</span>
0697        <span class="keyword">for</span> i=1:numel(grRules)
0698           <span class="keyword">if</span> any(grRules{i})
0699               <span class="keyword">if</span> ~strcmp(grRules{i}(1),<span class="string">'('</span>)
0700                   grRules{i}=[<span class="string">'('</span> grRules{i} <span class="string">')'</span>];
0701               <span class="keyword">end</span>
0702           <span class="keyword">end</span>
0703        <span class="keyword">end</span>
0704        [rxnGeneMat, genes]=<a href="#_sub1" class="code" title="subfunction [rxnGeneMat, matchGenes]=getGeneMat(grRules,matchGenes)">getGeneMat</a>(grRules);
0705        model.rxnGeneMat=rxnGeneMat;
0706        model.genes=genes;
0707        model.grRules=grRules;
0708     <span class="keyword">end</span>
0709 <span class="keyword">end</span>
0710 
0711 <span class="comment">%If any InChIs have been loaded</span>
0712 <span class="keyword">if</span> any(~cellfun(@isempty,metaboliteInChI))
0713     model.inchis=metaboliteInChI;
0714 <span class="keyword">end</span>
0715 
0716 <span class="comment">%If any formulas have been loaded</span>
0717 <span class="keyword">if</span> any(~cellfun(@isempty,metaboliteFormula))
0718     model.metFormulas=metaboliteFormula;
0719 <span class="keyword">end</span>
0720 
0721 <span class="comment">%If any gene short names have been loaded</span>
0722 <span class="keyword">if</span> any(~cellfun(@isempty,geneShortNames))
0723     model.geneShortNames=geneShortNames;
0724 <span class="keyword">end</span>
0725 
0726 <span class="comment">%If any Miriam strings for compartments have been loaded</span>
0727 <span class="keyword">if</span> any(~cellfun(@isempty,compartmentMiriams))
0728     model.compMiriams=compartmentMiriams;
0729 <span class="keyword">end</span>
0730 
0731 <span class="comment">%If any Miriam strings for metabolites have been loaded</span>
0732 <span class="keyword">if</span> any(~cellfun(@isempty,metaboliteMiriams))
0733     model.metMiriams=metaboliteMiriams;
0734 <span class="keyword">end</span>
0735 
0736 <span class="comment">%If any subsystems have been loaded</span>
0737 <span class="keyword">if</span> any(~cellfun(@isempty,subsystems))
0738     model.subSystems=subsystems;
0739 <span class="keyword">end</span>
0740 <span class="keyword">if</span> any(rxnComps)
0741    <span class="keyword">if</span> all(rxnComps)
0742        model.rxnComps=rxnComps;
0743    <span class="keyword">else</span>
0744        <span class="keyword">if</span> supressWarnings==false
0745             <a href="dispEM.html" class="code" title="function dispEM(string,throwErrors,toList,trimWarnings)">dispEM</a>(<span class="string">'The compartments for the following reactions could not be matched. Ignoring reaction compartment information'</span>,false,model.rxns(rxnComps==0));
0746        <span class="keyword">end</span>
0747    <span class="keyword">end</span>
0748 <span class="keyword">end</span>
0749 
0750 <span class="comment">%If any ec-codes have been loaded</span>
0751 <span class="keyword">if</span> any(~cellfun(@isempty,eccodes))
0752     model.eccodes=eccodes;
0753 <span class="keyword">end</span>
0754 
0755 <span class="comment">%If any Miriam strings for reactions have been loaded</span>
0756 <span class="keyword">if</span> any(~cellfun(@isempty,rxnMiriams))
0757     model.rxnMiriams=rxnMiriams;
0758 <span class="keyword">end</span>
0759 
0760 <span class="comment">%If any Miriam strings for genes have been loaded</span>
0761 <span class="keyword">if</span> any(~cellfun(@isempty,geneMiriams))
0762     model.geneMiriams=geneMiriams;
0763 <span class="keyword">end</span>
0764 
0765 model.unconstrained=metaboliteUnconstrained;
0766 
0767 <span class="comment">%Remove unused fields</span>
0768 <span class="keyword">if</span> isempty(model.annotation)
0769     model=rmfield(model,<span class="string">'annotation'</span>);
0770 <span class="keyword">end</span>
0771 <span class="keyword">if</span> isempty(model.compOutside)
0772     model=rmfield(model,<span class="string">'compOutside'</span>);
0773 <span class="keyword">end</span>
0774 <span class="keyword">if</span> isempty(model.compMiriams)
0775     model=rmfield(model,<span class="string">'compMiriams'</span>);
0776 <span class="keyword">end</span>
0777 <span class="keyword">if</span> isempty(model.rxnComps)
0778     model=rmfield(model,<span class="string">'rxnComps'</span>);
0779 <span class="keyword">end</span>
0780 <span class="keyword">if</span> isempty(model.grRules)
0781     model=rmfield(model,<span class="string">'grRules'</span>);
0782 <span class="keyword">end</span>
0783 <span class="keyword">if</span> isempty(model.rxnGeneMat)
0784     model=rmfield(model,<span class="string">'rxnGeneMat'</span>);
0785 <span class="keyword">end</span>
0786 <span class="keyword">if</span> isempty(model.subSystems)
0787     model=rmfield(model,<span class="string">'subSystems'</span>);
0788 <span class="keyword">end</span>
0789 <span class="keyword">if</span> isempty(model.eccodes)
0790     model=rmfield(model,<span class="string">'eccodes'</span>);
0791 <span class="keyword">end</span>
0792 <span class="keyword">if</span> isempty(model.rxnMiriams)
0793     model=rmfield(model,<span class="string">'rxnMiriams'</span>);
0794 <span class="keyword">end</span>
0795 <span class="keyword">if</span> isempty(model.genes)
0796     model=rmfield(model,<span class="string">'genes'</span>);
0797 <span class="keyword">end</span>
0798 <span class="keyword">if</span> isempty(model.geneComps)
0799     model=rmfield(model,<span class="string">'geneComps'</span>);
0800 <span class="keyword">end</span>
0801 <span class="keyword">if</span> isempty(model.geneMiriams)
0802     model=rmfield(model,<span class="string">'geneMiriams'</span>);
0803 <span class="keyword">end</span>
0804 <span class="keyword">if</span> isempty(model.inchis)
0805     model=rmfield(model,<span class="string">'inchis'</span>);
0806 <span class="keyword">end</span>
0807 <span class="keyword">if</span> isempty(model.metFormulas)
0808     model=rmfield(model,<span class="string">'metFormulas'</span>);
0809 <span class="keyword">end</span>
0810 <span class="keyword">if</span> isempty(model.metMiriams)
0811     model=rmfield(model,<span class="string">'metMiriams'</span>);
0812 <span class="keyword">end</span>
0813 
0814 <span class="comment">%This just removes the grRules if no genes have been loaded</span>
0815 <span class="keyword">if</span> ~isfield(model,<span class="string">'genes'</span>) &amp;&amp; isfield(model,<span class="string">'grRules'</span>)
0816    model=rmfield(model,<span class="string">'grRules'</span>); 
0817 <span class="keyword">end</span>
0818 
0819 <span class="comment">%Print warnings about bad structure</span>
0820 <span class="keyword">if</span> supressWarnings==false
0821     <a href="checkModelStruct.html" class="code" title="function checkModelStruct(model,throwErrors,trimWarnings)">checkModelStruct</a>(model,false);
0822 <span class="keyword">end</span>
0823 
0824 <span class="keyword">if</span> removeExcMets==true
0825     model=<a href="simplifyModel.html" class="code" title="function [reducedModel, deletedReactions, deletedMetabolites]=simplifyModel(model,deleteUnconstrained, deleteDuplicates, deleteZeroInterval, deleteInaccessible, deleteMinMax, groupLinear, reservedRxns, suppressWarnings)">simplifyModel</a>(model);
0826 <span class="keyword">end</span>
0827 <span class="keyword">end</span>
0828 
0829 <a name="_sub1" href="#_subfunctions" class="code">function [rxnGeneMat, matchGenes]=getGeneMat(grRules,matchGenes)</a>
0830 <span class="comment">%Constructs the rxnGeneMat matrix and the cell array with gene names from</span>
0831 <span class="comment">%the grRules. Uses the genes in the order defined by matchGenes if supplied. No</span>
0832 <span class="comment">%checks are made here since that should have been made before.</span>
0833 
0834 <span class="keyword">if</span> nargin&lt;2
0835     matchGenes={};
0836 <span class="keyword">end</span>
0837 
0838 <span class="comment">%Assume that everything that isn't a paranthesis, &quot; AND &quot; or &quot; or &quot; is a</span>
0839 <span class="comment">%gene name</span>
0840 genes=strrep(grRules,<span class="string">'('</span>,<span class="string">''</span>);
0841 genes=strrep(genes,<span class="string">')'</span>,<span class="string">''</span>);
0842 genes=strrep(genes,<span class="string">' or '</span>,<span class="string">' '</span>);
0843 genes=strrep(genes,<span class="string">' and '</span>,<span class="string">' '</span>);
0844 [crap crap crap crap crap crap genes]=regexp(genes,<span class="string">' '</span>);
0845 
0846 <span class="keyword">if</span> isempty(matchGenes)
0847     allNames={};
0848     <span class="keyword">for</span> i=1:numel(genes)
0849         allNames=[allNames genes{i}];
0850     <span class="keyword">end</span>
0851     matchGenes=unique(allNames)';
0852     
0853     <span class="comment">%Remove the empty element if present</span>
0854     <span class="keyword">if</span> isempty(matchGenes{1})
0855         matchGenes(1)=[];
0856     <span class="keyword">end</span>
0857 <span class="keyword">end</span>
0858 
0859 <span class="comment">%Create the matrix</span>
0860 rxnGeneMat=zeros(numel(genes),numel(matchGenes));
0861 
0862 <span class="keyword">for</span> i=1:numel(genes)
0863     <span class="keyword">if</span> ~isempty(genes{i})
0864         <span class="keyword">for</span> j=1:numel(genes{i})
0865             <span class="keyword">if</span> ~isempty(genes{i}{j})
0866                 index=find(strcmp(genes{i}{j},matchGenes));
0867                 <span class="keyword">if</span> numel(index)==1
0868                     rxnGeneMat(i,index)=1;
0869                 <span class="keyword">else</span>
0870                     <a href="dispEM.html" class="code" title="function dispEM(string,throwErrors,toList,trimWarnings)">dispEM</a>([<span class="string">'The gene '</span> genes{i}{j} <span class="string">' could not be matched to a gene in the gene list.'</span>]); 
0871                 <span class="keyword">end</span>
0872             <span class="keyword">end</span>
0873         <span class="keyword">end</span>
0874     <span class="keyword">end</span>
0875 <span class="keyword">end</span>
0876 rxnGeneMat=sparse(rxnGeneMat);
0877 <span class="keyword">end</span>
0878 
0879 <a name="_sub2" href="#_subfunctions" class="code">function miriamStruct=parseMiriam(searchString)</a>
0880 <span class="comment">%Gets the names and values of Miriam-string. Nothing fancy at all, just to</span>
0881 <span class="comment">%prevent using the same code for metabolites, genes, and reactions</span>
0882 
0883 <span class="keyword">if</span> ~isempty(searchString)    
0884     startString=<span class="string">'urn:miriam:'</span>;
0885     midString=<span class="string">':'</span>;
0886     endString=<span class="string">'&quot;'</span>;
0887     startIndexes=strfind(searchString,startString);
0888     midIndexes=strfind(searchString,midString);
0889     endIndexes=strfind(searchString,endString);
0890     miriamStruct=[];
0891 
0892     <span class="keyword">if</span> ~isempty(startIndexes)
0893         counter=0;
0894         <span class="keyword">for</span> j=1:numel(startIndexes)
0895             endIndex=find(endIndexes&gt;startIndexes(j)+numel(startString), 1 );
0896             
0897             midIndex=find(midIndexes&gt;startIndexes(j)+numel(startString) &amp; midIndexes&lt;endIndexes(endIndex),1);
0898             
0899             <span class="comment">%It was like this before and I don't understand why!</span>
0900             <span class="comment">%midIndex=find(midIndexes&lt;endIndexes(endIndex),1,'last');</span>
0901             
0902             miriam=searchString(startIndexes(j)+numel(startString):midIndexes(midIndex)-1);
0903 
0904             <span class="comment">%Construct the struct</span>
0905             <span class="keyword">if</span> ~strcmpi(miriam,<span class="string">'ec-code'</span>)
0906                 counter=counter+1;
0907                 miriamStruct.name{counter,1}=miriam;
0908                 <span class="keyword">if</span> any(midIndex)
0909                     miriamStruct.value{counter,1}=searchString(midIndexes(midIndex)+1:endIndexes(endIndex)-1);
0910                 <span class="keyword">else</span>
0911                     <span class="comment">%This is if there is no miriam type defined, but that</span>
0912                     <span class="comment">%there still is some value defined</span>
0913                     miriamStruct.value{counter,1}=searchString(startIndexes(j)+numel(startString):endIndexes(endIndex)-1);
0914                 <span class="keyword">end</span>
0915             <span class="keyword">end</span>
0916         <span class="keyword">end</span>
0917     <span class="keyword">end</span>
0918 <span class="keyword">else</span>
0919     miriamStruct=[];
0920 <span class="keyword">end</span>
0921 <span class="keyword">end</span></pre></div>
<hr><address>Generated on Mon 06-Jan-2014 14:58:12 by <strong><a href="http://www.artefact.tk/software/matlab/m2html/" title="Matlab Documentation in HTML">m2html</a></strong> &copy; 2005</address>
</body>
</html>